#textdomain wesnoth-tfow
[scenario]
    id=06_Prince_of_Evil
    name= _ "Prince of Evil"
    map_data="{~add-ons/The_Fall_of_Wesnoth/maps/06_Prince_of_Evil.map}"
    next_scenario=07_From_the_Clutches
    victory_when_enemies_defeated=no
    bonus=yes
	
    {TURNS4 65 62 60 57}
	{UNDERGROUND}
	
    [time_area]
        x=53,52
        y=33-40,35-38
		
        {DAWN}
        {MORNING}
        {MIDDAY}
        {AFTERNOON}
        {DUSK}
        {SHORTDARK}
    [/time_area]
	
	# Load music
    {SCENARIO_MUSIC tribal_war_song.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}
    {EXTRA_SCENARIO_MUSIC the_deep_path.ogg}
	
	# Load story part
	{CHAPTER6}

    [side]
        type=Sergeant
        id=Alitar
        name= _ "Alitar"
        unrenamable=yes
		canrecruit=yes
		profile=portraits/alitar.png
        side=1
        team_name=good
        user_team_name=_"Survivors"
        controller=human
		recruit=FootpadN, ThugN, PoacherN, Thief, Tracker
		color=blue
		fog=no
		shroud=yes
        share_maps=no
        share_view=no
		gold=0
        {FLAG_VARIANT ragged}
    [/side]
	
    [side]
		no_leader=yes
        side=2
        team_name=good
        user_team_name=_"Trolls"
        controller=ai
		color=teal
		fog=no
		shroud=yes
        share_maps=no
        share_view=no
        {FLAG_VARIANT ragged}
    [/side]
	#
	# Evil minions
	#
    [side]
        type=Deathblade
        id=Guardian
        name= _ ""
        unrenamable=yes
		canrecruit=yes
        side=3
        team_name=evil
        user_team_name=_"Undead"
        controller=ai
		recruit=Skeleton, Skeleton Archer, Vampire Bat
        [ai]
			passive_leader=yes
            aggression=-1.0
            caution=0.4
            grouping=defensive
			attack_depth=2
        [/ai]
		{GOLD4 100 120 145 175}
        {FLAG_VARIANT undead}
    [/side]
	
    [side]
        type=Spectre
        id=Ambusher
        name= _ ""
        unrenamable=yes
		canrecruit=yes
        side=4
        team_name=evil
        user_team_name=_"Undead"
        controller=ai
		gold=1000
		hidden=yes
#ifdef EASY
        recruit=Revenant, Bone Shooter, Bone Knight, Dark Adept, Ghoul
        [ai]
            recruitment_pattern=fighter,archer,scout,scout
        [/ai]
#endif

#ifdef NORMAL
        recruit=Revenant, Bone Shooter, Bone Knight, Dark Sorcerer, Ghoul
        [ai]
            recruitment_pattern=fighter,archer,scout,mixed fighter,fighter
        [/ai]
#endif

#ifdef HARD
        recruit=Revenant, Deathblade, Bone Shooter, Bone Knight, Dark Sorcerer, Ghoul
        [ai]
            recruitment_pattern=fighter,archer,scout,mixed fighter,archer,fighter
        [/ai]
#endif

#ifdef NIGHTMARE
        recruit=Draug, Deathblade, Bone Shooter, Bone Knight, Dark Sorcerer, Necrophage
        [ai]
            recruitment_pattern=fighter,mixed fighter,archer,scout,scout,fighter
        [/ai]
#endif
        [ai]
            {ATTACK_DEPTH4 1 2 2 3}
            recruitment_ignore_bad_combat=yes
            recruitment_ignore_bad_movement=yes
            aggression=5.0
            caution=-1.0
            grouping=no
        [/ai]
		{INCOME4 10 12 14 16}
        {FLAG_VARIANT undead}
    [/side]
	#
	# The prince of evil
	#
    [side]
        type=Ancient Lich TFoW
        id=Evad
        name= _ "Evad"
        unrenamable=yes
		canrecruit=yes
		profile=portraits/evad.png
        side=5
        team_name=evil
        user_team_name=_"Undead"
        controller=ai
		persistent=yes
		save_id=yes
#ifdef EASY
        recruit=Skeleton, Skeleton Archer, Skeleton Rider, Ghoul, Dark Adept, Ghost, Revenant, Bone Shooter, Bone Knight, Death Squire, Necrophage, Wraith, Shadow, Dark Sorcerer
#endif

#ifdef NORMAL
        recruit=Skeleton, Skeleton Archer, Skeleton Rider, Ghoul, Ghost, Revenant, Deathblade, Bone Shooter, Bone Knight, Death Squire, Necrophage, Wraith, Shadow, Dark Sorcerer
#endif

#ifdef HARD
        recruit=Revenant, Bone Shooter, Bone Knight, Death Squire, Necrophage, Wraith, Shadow, Dark Sorcerer, Draug, Banebow, Chocobone, Death Knight, Necromancer
#endif

#ifdef NIGHTMARE
        recruit=Revenant, Deathblade, Bone Shooter, Bone Knight, Death Squire, Necrophage, Wraith, Shadow, Dark Sorcerer, Draug, Banebow, Chocobone, Death Knight, Necromancer, Lich
#endif
		[ai]
			[leader_goal]
				x,y=22,4
			[/leader_goal]
		
			[target]
				id=Alitar
				value=100
			[/target]
			
            {ATTACK_DEPTH4 1 2 2 3}
            aggression=0.75
            caution=-1.0
            leader_value=100
            grouping=no
        [/ai]
        {FLAG_VARIANT undead}
    [/side]
	
    [side]
		no_leader=yes
        side=6
        team_name=evil
        user_team_name=_"Bats"
        controller=ai
		hidden=yes
		fog=no
		shroud=no
        [ai]
            recruitment_ignore_bad_combat=yes
            recruitment_ignore_bad_movement=yes
            aggression=1.1
			simple_targeting=yes
        [/ai]
        {FLAG_VARIANT ragged}
    [/side]
	
    [side]
		no_leader=yes
        side=7
        team_name=bad
        user_team_name=_"Lava Dwellers"
        controller=ai
		hidden=yes
		fog=no
		shroud=no
        [ai]
			[target]
				side=7
				value=50
			[/target]
			
			[target]
				side=1
				value=90
			[/target]
			simple_targeting=yes
            recruitment_ignore_bad_combat=yes
            recruitment_ignore_bad_movement=yes
        [/ai]
        {FLAG_VARIANT ragged}
    [/side]
	
    [side]
		no_leader=yes
        side=8
        team_name=bad
        user_team_name=_"Ants"
        controller=ai
		hidden=yes
		fog=no
		shroud=no
        [ai]
			[target]
				side=1
				value=100
			[/target]
			
            aggression=0.65
			simple_targeting=yes
            recruitment_ignore_bad_combat=yes
            recruitment_ignore_bad_movement=yes
        [/ai]
        {FLAG_VARIANT ragged}
    [/side]
	
    {LIMIT_RECRUITS 4 "Dark Adept" 1}
    {LIMIT_RECRUITS 4 "Dark Sorcerer" 1}
    {LIMIT_RECRUITS 4 "Skeleton Rider" 1}
    {LIMIT_RECRUITS 4 "Bone Knight" 1}
	
    {ANIMATED_CAMPFIRE 6 32}
	
	#
	# Prepare scenario
	#
    [event]
        name=prestart
		
		# Sound source for the campfire.
		[sound_source]
			id=campfire
			sounds=ambient/campfire.ogg
			x,y=6,32
			loop=-1
			check_shrouded=true
		[/sound_source]
		
        {PLACE_IMAGE items/bones.png 24 28}
        {PLACE_IMAGE items/bonestack.png 23 9}
        {PLACE_IMAGE items/bonestack.png 21 9}
        {PLACE_IMAGE items/altar-evil.png 22 5}
        {PLACE_IMAGE items/brazier.png 22 3}
        {PLACE_IMAGE items/burial.png 46 18}
        {PLACE_IMAGE scenery/monolith2.png 25 6}
        {PLACE_IMAGE scenery/monolith2.png 19 6}
		
		{LOYAL_UNDEAD_UNIT 5 "Draug" 21 11} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 5 "Draug" 23 11} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 5 "Spider Lich" 21 4} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 5 "Spider Lich" 23 4} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 5 "Death Knight" 19 7} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 5 "Death Knight" 25 7} {GUARDIAN}
		
		{GENERIC_UNIT 6 "Vampire Bat" 13 21} {GUARDIAN}
		{GENERIC_UNIT 6 "Vampire Bat" 14 20} {GUARDIAN}
		{GENERIC_UNIT 6 "Blood Bat" 14 21} {GUARDIAN}
		{GENERIC_UNIT 6 "Vampire Bat" 40 20} {GUARDIAN}
		{GENERIC_UNIT 6 "Blood Bat" 39 21} {GUARDIAN}
		
        [unit]
            type=Troll Shaman
            id=Rushk
            name= _ "Rushk"
			unrenamable=yes
			#profile=portraits/rushk.png
			ai_special=guardian
            side=2
            x,y=7,31
			facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_LOYAL}
            [/modifications]
            {IS_HERO}
        [/unit]
		
		[unit]
			type=Troll Whelp
			id=Whelp1
			generate_name=yes
			random_traits=yes
			ai_special=guardian
			side=2
			x,y=4,31
			facing=se
		[/unit]
		
		[unit]
			type=Troll Whelp
			id=Whelp2
			generate_name=yes
			random_traits=yes
			ai_special=guardian
			side=2
			x,y=7,34
			facing=sw
		[/unit]
		
		[unit]
			type=Troll Whelp
			id=Whelp3
			generate_name=yes
			random_traits=yes
			ai_special=guardian
			side=2
			x,y=8,32
			facing=nw
		[/unit]
		
        [objectives]
            side=1
            [objective]
                description= _ "Clear the cave of its inhabitants"
                condition=win
            [/objective]
			
            [objective]
                description= _ "Death of Alitar"
                condition=lose
            [/objective]
			
			{TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
		
		{VARIABLE armor_taken 0}
		{VARIABLE met_evad no}
		{VARIABLE exit_found no}
		{VARIABLE illumination 2}
    [/event]
	#
	# Automaticaly recall units from previous scenario
	#
    [event]
        name=start
		
        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        cave_invaders=yes
                    [/variables]
                [/filter_wml]
            [/filter]

            kill=yes
            variable=units_invading_cave
        [/store_unit]

        {FOREACH units_invading_cave i}
            {VARIABLE units_invading_cave[$i].upkeep loyal}

            [unstore_unit]
                variable=units_invading_cave[$i]
                find_vacant=no
            [/unstore_unit]

            [recall]
                id=$units_invading_cave[$i].id
            [/recall]
        {NEXT i}

        {CLEAR_VARIABLE units_invading_cave}
		
        [sound]
            name=wail-sml.wav
        [/sound]
		
		[delay]
			time=600
		[/delay]
		
        [message]
            id=Alitar
			# wmllint: local spelling Shh
            message= _ "Shh... did you hear that? It was a wail of some kind."
        [/message]
		
        [store_unit]
            [filter]
                role=Friend
            [/filter]
            kill=no
            variable=stored_friend
        [/store_unit]
		
        [message]
            type=Tracker, Hunter, Prowler, PoacherN, TrapperN, RangerN, HuntsmanN
            message= _ "$stored_friend.name| was right, this place is creepy."
        [/message]
		
        [message]
            type=Thief, Rogue, Assassin, ThugN, BanditN, HighwaymanN
            message= _ "Come on, it's just a cave. Nothing bad about that."
        [/message]
		
        [message]
            id=Alitar
            message= _ "This place feels like it's more than just a cave. I can feel... a presence... I don't know what, or who, it is, but-"
        [/message]
		
		[delay]
			time=500
		[/delay]
		
        [message]
            type=Tracker, Hunter, Prowler, FootpadN, OutlawN, FugitiveN
            message= _ "Uh... is something wrong, Alitar?"
        [/message]
		
        [message]
            id=Alitar
            message= _ "Fear. It's fear... something down here is..."
        [/message]
		
        [message]
            id=Alitar
			# wmllint: local spelling Meh
            message= _ "...(<i>Shakes head</i>) Meh, it's nothing - Onward!"
        [/message]
    [/event]
	#
	# We have to remove the castle keeps to prevent
	# Alitar from recruiting. We don't want the
	# player getting any more units, now do we? ;)
	#
	[event]
		name=sighted
		
		[filter]
			id=Guardian
		[/filter]
		
		[message]
			id=Guardian
			message= _ "INTRUDERS!! KILL THEM!!"
		[/message]
		
		{MODIFY_UNIT id=Guardian canrecruit no}
		
        [terrain]
            x,y=20,32
            terrain=Cud
        [/terrain]
		
		[message]
			side=1
			[not]
				id=Alitar
			[/not]
			message= _ "Looks like there's undead in these caves after all."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Yes, but I feel that we should still proceed, and attempt to destroy whatever evil is down here."
		[/message]
		
        [objectives]
            side=1
            [objective]
                description= _ "Destroy all the undead leaders"
                condition=win
            [/objective]
			
            [objective]
                description= _ "Death of Alitar"
                condition=lose
            [/objective]
			
			{TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
	[/event]
	#
	# Player finds the armor
	#
	[event]
		name=moveto
		
		[filter]
			x,y=24,28
			side=1
		[/filter]
		
	    [message]
            speaker=unit
            message= _ "That skeleton... He's wearing a breast plate that appears to not be rusted by years of decay."
        [/message]
	[/event]
	#
	# The path is blocked by a pit so we'll have some talking
	#
	[event]
		name=moveto
		
		[filter]
			x=12,13,14
			y=30,30,29
			side=1
		[/filter]
		
		[if]
            [variable]
                name=unit.id
                equals=Alitar
            [/variable]
			
			[then]
				[message]
					id=Alitar
					# wmllint: local spelling gonna
					message= _ "Not gonna get across that way."
				[/message]
				
				[message]
					side=1
					[not]
						id=Alitar
					[/not]
					message= _ "And it looks like there's no way around either."
				[/message]
			[/then]
			
			[else]
				[message]
					speaker=unit
					message= _ "Woops, looks like someone forgot to build a bridge."
				[/message]
		
				[message]
					id=Alitar
					message= _ "No way across?"
				[/message]
		
				[message]
					speaker=unit
					message= _ "Nope, and no way around either from the looks of it."
				[/message]
			[/else]
		[/if]
	[/event]
	#
	# Any wesnoth player should already know
	# to check the walls for secret passages ;)
	#
	[event]
		name=moveto
		
		[filter]
			x,y=11,31
			side=1
		[/filter]
		
		[message]
			speaker=unit
			message= _ "On second thought, it looks like we might be able to get through here."
		[/message]
		
		[message]
			speaker=unit
			message= _ "Just give me a moment to... <i>Rrrruhh</i>..." # wmllint: no spellcheck
		[/message]
		
		[delay]
			time=1000
		[/delay]
		
        [sound]
            name=explosion.ogg
        [/sound]
		
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "<i><big>Crash!</big></i>   "
		[/message]
		
        [terrain]
            x,y=11,32
            terrain=Rb
        [/terrain]
		
		[message]
			speaker=unit
			message= _ "There. That's better."
		[/message]
		
		{GENERIC_UNIT 8 "Giant Ant" 9 38}
		{GENERIC_UNIT 8 "Giant Ant" 9 37}
		{GENERIC_UNIT 8 "Giant Ant" 10 36}
		{GENERIC_UNIT 8 "Giant Ant" 11 36}
	[/event]
	#
	# Execute the "meeting ants" dialog
	#
	{ON_SIGHTING () 1 side=8 (
		[message]
			speaker=unit
			message= _ "Ants! Big ones!"
		[/message]
		
		[message]
			id=Alitar
			# wmllint: local spelling Heh
			message= _ "Heh, even though they're big, they still look pathetically weak."
		[/message]
		
		# Player discovers them - Unhide!
		[modify_side]
			side=8
			hidden=no
		[/modify_side]
    )}
	#
	# You now meet trolls, who are much nicer than ants :D
	#
    [event]
        name=sighted
		
        [filter]
            side=2
        [/filter]
		
		[message]
			side=2
			message= _ "Who goes there?"
		[/message]
		
		[if]
            [variable]
                name=unit.id
                equals=Alitar
            [/variable]
			
			# wmllint: local spelling Ahhh
			[then]
				[message]
					side=1
					[not]
						id=Alitar
					[/not]
					message= _ "Ahhh! Trolls!"
				[/message]
			[/then]
			
			[else]
				[message]
					speaker=second_unit
					message= _ "Ahhh! Trolls!"
				[/message]
			[/else]
		[/if]
		
		[message]
			side=2
			# Troll talk :)
			# wmllint: local spelling doin'
			message= _ "Humans? What they doin' down here?"
		[/message]
		
		[message]
			id=Alitar
			message= _ "Hold on..."
		[/message]
		
		{MOVE_UNIT id=Alitar 4 33}
		
		[redraw]
			side=1
		[/redraw]
		
		[message]
			id=Alitar
			message= _ "Peace. We come in peace, trolls."
		[/message]
		
		[message]
			id=Rushk
			message= _ "How does Rushk know you not lying?"
		[/message]
		
		[message]
			id=Alitar
			message= _ "Well... if we wanted to kill you, we would have done so already."
		[/message]
		
		[message]
			id=Rushk
			message= _ "Err... you would have <i>tried</i> to kill us. We better than you think."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Of course. We aren't here to fight you; We are here to find safe haven from the undead."
		[/message]
		
		[message]
			id=Rushk
			# wmllint: local spelling Da
			# wmllint: local spelling 'em
			# wmllint: local spelling ain't
			message= _ "Da skeletons? Yeah, we trolls seen 'em too, but we no hide from them. We ain't like you small humans, we don't hide like coward, we fight like hero!"
		[/message]
		
		[message]
			id=Alitar
			message= _ "We aren't hiding from them, we're trying to root them out of this cave. Will you help us?"
		[/message]
		
		[message]
			id=Rushk
			message= _ "Rushk not know. You seem to cowardly for Rushk's taste."
		[/message]
		
        [store_unit]
            [filter]
                id=Whelp1
            [/filter]
            kill=no
            variable=stored_whelp1
        [/store_unit]
		
		[message]
			id=Whelp1
			message={WHISPER _"$stored_whelp1.name always thought humans were bigger."}
		[/message]
		
        [store_unit]
            [filter]
                id=Whelp2
            [/filter]
            kill=no
            variable=stored_whelp2
        [/store_unit]
		
		[message]
			id=Whelp2
			message={WHISPER _"$stored_whelp2.name thought so too."}
		[/message]
		
		[message]
			id=Rushk
			# wmllint: local spelling 'em
			message= _ "Quiet, $stored_whelp1.name. And you too, $stored_whelp2.name. We never seen humans with flesh before; We just see skeletons, and humans with only half there flesh. Rushk not know if he want to join you. There aren't even any undead to crush, we already smash 'em all. Many weeks ago."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Well then they must have returned because we just met some back there, and we believe there are also undead further down this tunnel."
		[/message]
		
		[message]
			id=Rushk
			message= _ "Rushk not know this. It possible more undead have come. They always do. Never stay dead. Always coming back to give trolls more trouble."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Whether you want to help or not, we're going to go and destroy the undead."
		[/message]
		
		[message]
			id=Rushk
			# wmllint: local spelling smashin'
			message= _ "Rushk always want in when it comes to smashin' stuff. We help you."
		[/message]
		
        {MODIFY_UNIT side=2 side 1}
		
		[message]
			id=Alitar
			message= _ "Thank you."
		[/message]
		
		[message]
			id=Whelp1
			message={WHISPER _"They still little guys."}
		[/message]
		
		[unit]
			type=Banebow
			id=Unexpected
			generate_name=yes
			random_traits=no
			side=5
			x,y=19,25
		[/unit]
		
		#secretly note that Rushk can't die
        [objectives]
			silent=yes
            side=1
            [objective]
                description= _ "Destroy all the undead leaders"
                condition=win
            [/objective]
			
            [objective]
                description= _ "Death of Alitar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rushk"
                condition=lose
            [/objective]
			
			{TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
	#
	# Skeleton dies, characters talk
	#
	[event]
		name=die
		
		[filter]
			id=Unexpected
		[/filter]
		
		[if]
			[have_unit]
				id=Whelp3
			[/have_unit]
			
			[then]
				[message]
					id=Alitar
					message= _ "See? Undead have returned to these caves."
				[/message]
		
				[store_unit]
					[filter]
						id=Whelp3
					[/filter]
					kill=no
					variable=stored_whelp3
				[/store_unit]
		
				[message]
					id=Whelp3
					message= _ "$stored_whelp3.name knew it! $stored_whelp3.name told you so, but you didn't listen."
				[/message]
		
				[message]
					id=Rushk
					message= _ "Rushk was wrong, so what."
				[/message]
		
				[message]
					id=Alitar
					message= _ "What are you talking about?"
				[/message]
		
				[message]
					id=Rushk
					# wmllint: local spelling yellin' somethin'
					message= _ "A few weeks ago, we heard someone yelling from this tunnel. He yellin' about a place called 'Wesnoth', somethin' about destruction and death. Rushk not know what he talking about, and Rushk didn't care."
				[/message]
		
				[message]
					id=Whelp3
					message= _ "But $stored_whelp3.name knew there was trouble! $stored_whelp3.name told 'em undead probably come back, but Rushk not listen."
				[/message]
		
				[message]
					id=Rushk
					message= _ "Shut up, $stored_whelp3.name."
				[/message]
		
				[message]
					id=Alitar
					message= _ "Now I know we have to destroy whatever evil is down here. Onward!"
				[/message]
			[/then]
			
			[else]
				[message]
					id=Alitar
					message= _ "See? Undead have returned to these caves."
				[/message]
		
				[message]
					id=Rushk
					# wmllint: local spelling yellin' somethin'
					message= _ "Now that Rushk think of it, we trolls heard someone yelling from this tunnel just a few weeks ago. He yellin' about a place called 'Wesnoth', somethin' about destruction and death. Rushk not know what he talking about, and Rushk didn't care."
				[/message]
		
				[message]
					id=Alitar
					message= _ "Really? Now I know we have to destroy whatever evil is down here. Onward!"
				[/message]
			[/else]
		[/if]
	[/event]
	#
	# Another hole
	#
    [event]
        name=moveto
		
		[filter]
			x,y=13,22
			side=1
		[/filter]
		
		[if]
            [variable]
                name=unit.race
                equals=human
            [/variable]
			
			[then]
				[message]
					speaker=unit
					message= _ "Great, another hole in our path."
				[/message]
			[/then]
			
			[else]
				[message]
					speaker=unit
					message= _ "We trolls dig tunnel that go around this hole."
				[/message]
			[/else]
		[/if]
    [/event]
	#
	# The lava pit is filled with hostile guardians
	#
    [event]
        name=moveto
		
		[filter]
			x=21-23
			y=22-24
			side=1
		[/filter]
		
		[message]
			speaker=unit
			message= _ "Gee, it's hot in here..."
		[/message]
		
		[sound]
			name=fire.wav
		[/sound]
		
		{GENERIC_UNIT 7 "Fire Guardian" 21 23}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 24 23}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 22 20}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 25 20}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 28 21}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 27 25}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 27 18}
		[+unit]
			animate=yes
		[/unit]
		
		{GENERIC_UNIT 7 "Fire Guardian" 24 17}
		[+unit]
			animate=yes
		[/unit]
		
		# Found lava dwellers? Unhide!
		[modify_side]
			side=7
			hidden=no
		[/modify_side]
		
		[message]
			type=Fire Guardian
			message= _ "Die, $unit.race! DIE!!"
		[/message]
		
		[message]
			speaker=unit
			message= _ "...and it just got hotter."
		[/message]
    [/event]
	#
	# The guards get angry
	#
    [event]
        name=sighted
		
		[filter]
			type=Draug
		[/filter]
		
		[message]
			type=Draug
			message= _ "YOU SHALL NOT PASS!!"
		[/message]
		
		[message]
			speaker=second_unit
			message= _ "Yeah, right."
		[/message]
    [/event]
	#
	# Let's warn the player about spreading his units across the map too much
	#
    [event]
        name=die
		
		[filter]
			type=Draug
		[/filter]
		
		[message]
			id=Alitar
			message= _ "I don't like it - the fearful feeling inside of me is growing stronger... We're close, very close to what is causing this fear. Let's continue, but cautiously, and as a group - we don't want anybody getting left behind."
		[/message]
    [/event]
	
#define EVAD_SUMMONS_MINION SIDE TYPE X Y
    [animate_unit]
        flag=attack

        [filter]
            id=Evad
        [/filter]

        [primary_attack]
            name=chill tempest
        [/primary_attack]

        hits=yes
		
		[facing]
            [filter]
                x,y=22,5
            [/filter]
        [/facing]
    [/animate_unit]
	
    {NOTRAIT_UNIT {SIDE} {TYPE} {X} {Y} }
    [+unit]
        animate=yes
    [/unit]
#enddef
	
	#
	# player meets the prince himself
	#
    [event]
        name=sighted
		
		[filter]
			id=Evad
		[/filter]
		
		[remove_shroud]
			side=1
			x=18-26
			y=2-9
		[/remove_shroud]
		
		[scroll_to]
			x,y=22,4
		[/scroll_to]
		
		[delay]
			time=900
		[/delay]
		
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "The party entered the chamber and was beholden by a most frightening sight: An ancient lich stood in the center of the chamber behind an evil altar which was covered in blood. On the liches' left and right, two other abominations stood with eight spider legs spreading across the broken, torn up castle floor. The ancient master of evil who stood behind the altar was wearing a magical, necromantic ankh around his neck that seemed to glow with dark power."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Oh, Light Lady protect us!"
		[/message]
		
		[message]
			id=Evad
			message= _ "Welcome to my domain, Alitar!"
		[/message]
		
		[message]
			id=Alitar
			message= _ "Alitar? How do you know my name?"
		[/message]
		
		[message]
			id=Evad
			message= _ "Oh, it's quite simple actually. But to explain it would defeat the purpose have holding the secret. My name is Evad, and I've been hoping we would meet face to face one of these days. You're turning into real legend, did you know that?"
		[/message]
		
		[message]
			id=Alitar
			message= _ "No...?"
		[/message]
		
		[message]
			id=Evad
			message= _ "I see you are confused so I will open your eyes a little wider in hopes of making you understand. I consider you a legend because of your actions against your king, against your warden, and against me. You are a fighter, Alitar; You stand up to those who you think are wrong, and those who have done wrong to you. Which is exactly why you are the perfect person to be used in my mother's plan of destruction."
		[/message]
		
		[message]
			id=Alitar
			message= _ "I have no wish to be apart of anything that involves destruction. You'll have to find somebody else to 'use'!"
		[/message]
		
		[message]
			id=Evad
			message= _ "You are a brave man, Alitar. But even brave men can't withstand fear... Are you afraid, Alitar?"
		[/message]
		
		[message]
			id=Alitar
			message= _ "......"
		[/message]
		
		[message]
			id=Alitar
			message= _ "I'm not afraid of you."
		[/message]
		
		[message]
			id=Evad
			message= _ "I think you are. I think you're terrified."
		[/message]
		
		[message]
			id=Alitar
			message= _ "Maybe I am, maybe not. But it doesn't matter since I came here to destroy the evil in these caves."
		[/message]
		
		[message]
			id=Evad
			message= _ "So you came to destroy me... I don't see how you plan to do that with fear in your heart."
		[/message]
		
		[message]
			id=Alitar
			image=portraits/alitar-angry.png
			message= _ "I am not afraid of you!"
		[/message]
		
		[message]
			id=Evad
			message= _ "That's what your mind says. But you and I both know that your heart says otherwise."
		[/message]
		
		[message]
			id=Alitar
			image=portraits/alitar-angry.png
			message= _ "I have defeated plenty of abominations like you! You are no different from the carrion foes I've defeated in the past!"
		[/message]
		
		[message]
			id=Evad
			message= _ "Oh, but that's where you are mistaken, Alitar. I am very different from the other liches you've reduced to dust. I am very different indeed. You are not frightened by my minions and yet, I terrify you. Doesn't that make you wonder?"
		[/message]
		
		[message]
			id=Alitar
			image=portraits/alitar-angry.png
			message= _ "I will destroy you with, or without fear in my heart!"
		[/message]
		
		[message]
			id=Evad
			message= _ "Once again you are wrong, Alitar. It will not be I who falls..."
		[/message]
		
		{EVAD_SUMMONS_MINION 5 "Revenant" 22 5}
		{EVAD_SUMMONS_MINION 5 "Bone Shooter" 23 5}
		{EVAD_SUMMONS_MINION 5 "Necrophage" 21 5}
		
		[music]
		    name=knalgan_theme.ogg
			immediate=yes
		[/music]
		
		[music]
		    name=suspense.ogg
			append=yes
		[/music]
		
		[message]
			id=Evad
			message= _ "Rest in chaos, Alitar. Rest in chaos."
		[/message]
		
		[message]
			type=Tracker, Hunter, Prowler, PoacherN, TrapperN, HuntsmanN, RangerN
			# wmllint: local spelling outta
			message= _ "Alitar, let's get outta here! Hurry!"
		[/message]
		
        {QUAKE "rumble.ogg"}
		
		{GENERIC_UNIT 5 "Blood Manipulator" 19 25}
		{GENERIC_UNIT 5 "Blood Apprentice" 18 25}
		{GENERIC_UNIT 5 "Blood Apprentice" 19 26}
		{GENERIC_UNIT 5 "Sangel" 13 22}
		{GENERIC_UNIT 5 "Noble" 12 22}
		{GENERIC_UNIT 5 "DuelistV" 13 23}
		{GENERIC_UNIT 5 "Gargoyle" 14 24}
		{GENERIC_UNIT 5 "Marlgoyle" 14 25}
		{GENERIC_UNIT 5 "Gargoyle" 15 26}
		
        {QUAKE "rumble.ogg"}
		
		[scroll_to]
			x,y=19,26
		[/scroll_to]
		
		[delay]
			time=600
		[/delay]
		
		[message]
			type=FootpadN, OutlawN, FugitiveN, Thief, Rogue, Assassin
			message= _ "What are those horrible looking things?!"
		[/message]
		
		[message]
			type=Tracker, Hunter, Prowler, PoacherN, TrapperN, HuntsmanN, RangerN
			message= _ "I don't know but they're blocking our escape and they look like they're out for blood - Our blood!"
		[/message]
	
		[message]
			id=Rushk
			message= _ "We'll never get out the way we came! But Rushk know of secret tunnel..."
		[/message]
		
		{MOVE_UNIT id=Rushk 23 13}
		
		[message]
			id=Rushk
			# wmllint: local spelling Da
			message= _ "<i>Rrruuughhh</i>, Da skeletons not know... <i>Uhhh</i> of... this tunnel." # wmllint: no spellcheck
		[/message]
		
		[delay]
			time=1000
		[/delay]
		
        [sound]
            name=explosion.ogg
        [/sound]
		
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "<i><big>Crash!</big></i>   "
		[/message]
		
        [terrain]
            x=24,24
			y=13,12
            terrain=Rb
        [/terrain]
		
		[set_variable]
		    name=met_evad
			value=yes
		[/set_variable]
		
		[redraw][/redraw]
	
		[message]
			id=Alitar
			message= _ "Quick! Everybody, inside! Run!"
		[/message]
		
		[message]
			type=ThugN, BanditN, HighwaymanN
			# wmllint: local spelling gonna
			message= _ "Alitar! Aren't we gonna fight? I thought we came here to destroy the undead?"
		[/message]
		
		[message]
			id=Alitar
			message= _ "We did, but we can't accomplish that now! Everybody, into the tunnel!"
		[/message]
		
        [objectives]
            side=1
            [objective]
                description= _ "Escape from the caves"
                condition=win
            [/objective]
			
            [objective]
                description= _ "Death of Alitar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rushk"
                condition=lose
            [/objective]
			
			{TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
	
	[event]
		name=moveto
		
		[filter]
			x=40-47
			y=27-32
			side=1
		[/filter]
	
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "As they hurried down the tunnel in hopes of escaping death, the party heard a rasping voice echo over the cavern walls..."
		[/message]
		
		[message]
			id=Evad
			message= _ "<big>Alitar! Stop running! You have nowhere to run, and what you are running from will always find you! It will torment you until you face it! You are being used whether you like it or not!</big>"
		[/message]
		
		[message]
			type=ThugN, BanditN, HighwaymanN
			message= _ "What the devil is he talking about!?"
		[/message]
		
		[message]
			id=Alitar
			# wmllint: local spelling gotta outta
			message= _ "I... I don't know... Just keep moving! We've gotta get outta here!"
		[/message]
		
		[delay]
			time=400
		[/delay]
		
        [sound]
            name=explosion.ogg
        [/sound]
		
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "<i><big>Crash!</big></i>   "
		[/message]
		
		[message]
			type=Thief, Rogue, Assassin
			message= _ "That didn't sound good."
		[/message]
		
        [terrain]
            x=47,48
			y=18,18
            terrain=Uh
        [/terrain]
		
		[redraw][/redraw]
		
		[remove_shroud]
			side=1
			x=47-50
			y=14-17
		[/remove_shroud]
		
		[message]
			id=Ambusher
			message= _ "JOIN US THROUGH DEATH!!"
		[/message]
		
		[message]
			id=Alitar
			message= _ "Hurry! We have to either out run them, or stop them from pursuing us!"
		[/message]
		
		[message]
			id=Rushk
			message= _ "Rushk been down this tunnel before, there big chasm father down. Over big chasm is bridge. Rushk can use magic to destroy bridge and stop undead!"
		[/message]
		
		[message]
			id=Alitar
			message= _ "Very well, but let's make sure everyone is on the right side before we blow it!"
		[/message]
		
		[remove_shroud]
			side=1
			x,y=38,33
		[/remove_shroud]
		
		{HIGHLIGHT_IMAGE 38 33 items/gohere.png ()}
		
		[place_shroud]
			side=1
			x,y=38,33
		[/place_shroud]
		
		#redraw in case you can already see it
		[redraw]
			side=1
		[/redraw]
		
		# The secret's out - Unhide!
		[modify_side]
			side=4
			hidden=no
		[/modify_side]
		
        [objectives]
            side=1
            [objective]
                description= _ "Blow up the bridge by moving Rushk to the target"
                condition=win
            [/objective]
			
            [objective]
                description= _ "Death of Alitar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rushk"
                condition=lose
            [/objective]
			
			{TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
			note= _ "Any units on the north side of the bridge will die once it's blown up."
        [/objectives]
    [/event]
	#
	# If the player manages to kill the spectre, then the
	# chances of him getting his keep are legit, so we'd
	# better keep the player from reaching it an recruiting.
	#
	[event]
		name=die
		
		[filter]
			id=Ambusher
		[/filter]
		
        [terrain]
            x,y=49,15
            terrain=Cud
        [/terrain]
	[/event]
	#
	# Now it's time to blow up the bridge
	#	
    [event]
        name=moveto
        first_time_only=no
		
		[filter]
			x,y=38,33
			id=Rushk
		[/filter]
		
        [message]
            id=Rushk
			# wmllint: local spelling da
            message= _ "Rushk ready to blow up da bridge."
        [/message]
        [message]
            id=Alitar
            message= _ "Let's make sure we are all across first..."
            [option]
                message= _ "All right, I think everybody's safe. Let 'er blow!"
                [command]
                    [message]
                        id=Rushk
                        message= _ "Bye bye, skeletons!"
                    [/message]
					
                    [animate_unit]
                        flag=attack

                        [filter]
                            id=Rushk
                        [/filter]

                        [primary_attack]
                            name=flame blast
                        [/primary_attack]

                        hits=yes
						
						[facing]
                            [filter]
                                x,y=39,33
                            [/filter]
                        [/facing]
                    [/animate_unit]
					
					[sound]
						name=explosion.ogg
					[/sound]

					[item]
						x,y=39,33
						halo=projectiles/fire-burst-small-1.png:50,projectiles/fire-burst-small-2.png:50,projectiles/fire-burst-small-3.png:50,projectiles/fire-burst-small-4.png:50,projectiles/fire-burst-small-5.png:50,projectiles/fire-burst-small-6.png:50,projectiles/fire-burst-small-7.png:50,projectiles/fire-burst-small-8.png:50,misc/blank-hex.png:1000000
					[/item]

					[kill]
						x,y=39,33
						animate=yes
						fire_event=yes
					[/kill]

					[terrain]
						x,y=39,33
						terrain=Qxu
					[/terrain]
					
                    [sound]
                        name=explosion.ogg
                    [/sound]
					
					[item]
						x,y=39,32
						halo=projectiles/fire-burst-small-1.png:50,projectiles/fire-burst-small-2.png:50,projectiles/fire-burst-small-3.png:50,projectiles/fire-burst-small-4.png:50,projectiles/fire-burst-small-5.png:50,projectiles/fire-burst-small-6.png:50,projectiles/fire-burst-small-7.png:50,projectiles/fire-burst-small-8.png:50,misc/blank-hex.png:1000000
					[/item]

					[kill]
						x,y=39,32
						animate=yes
						fire_event=yes
					[/kill]

					[terrain]
						x,y=39,32
						terrain=Qxu
					[/terrain]
					
	                [sound]
                        name=explosion.ogg
                    [/sound]
					
					[item]
						x,y=40,31
						halo=projectiles/fire-burst-small-1.png:50,projectiles/fire-burst-small-2.png:50,projectiles/fire-burst-small-3.png:50,projectiles/fire-burst-small-4.png:50,projectiles/fire-burst-small-5.png:50,projectiles/fire-burst-small-6.png:50,projectiles/fire-burst-small-7.png:50,projectiles/fire-burst-small-8.png:50,misc/blank-hex.png:1000000
					[/item]

					[kill]
						x,y=40,31
						animate=yes
						fire_event=yes
					[/kill]

					[terrain]
						x,y=40,31
						terrain=Qxu
					[/terrain]
					
                    [redraw][/redraw]
					
                    [kill]
						x=40-53
						y=18-33
                        side=1
                        fire_event=yes
                        animate=yes
                    [/kill]
					
                    [if]
                        [have_unit]
                            id=Alitar
                        [/have_unit]
						
                        [have_unit]
                            id=Rushk
                        [/have_unit]

                        [then]
                            [message]
                                id=Alitar
                                message= _ "Phew... We made it..."
                            [/message]
							
                            [endlevel]
                                result=victory
                            [/endlevel]
                        [/then]
                    [/if]
                [/command]
            [/option]
			
            [option]
                message= _ "No, I don't think everybody's safe..."
                [command]
                    [message]
                        id=Rushk
                        message= _ "Bah! Slow humans."
                    [/message]

                    [allow_undo][/allow_undo]
                [/command]
            [/option]
        [/message]
    [/event]
	
	[event]
		name=moveto
		
		[filter]
			x=49-54
			y=36-38
		[/filter]
		
        [message]
            speaker=unit
            message= _ "At last! The exit to these accursed caves."
        [/message]
		
        [message]
            id=Alitar
            message= _ "We must blow up the bridge before we leave. Otherwise, the undead will continue pursuing us!"
        [/message]
		
		[set_variable]
			name=exit_found
			value=yes
		[/set_variable]
	[/event]
	#
	# Player won the scenario
	#
	[event]
		name=victory
		
		[if]
			[variable]
				name=exit_found
				equals=no
			[/variable]
			
			[then]
				{MOVE_UNIT id=Alitar 50 37}
		
				[redraw]
					side=1
				[/redraw]
		
				[message]
					id=Alitar
					message= _ "At last! The exit to these accursed caves..."
				[/message]
			[/then]
			
			[else]
				{MOVE_UNIT id=Alitar 50 37}
			
				[message]
					id=Alitar
					message= _ "Come on, lets leave these caves..."
				[/message]
			[/else]
		[/if]
		
        {MODIFY_UNIT (
            side=1
            {NOT_ON_RECALL_LIST}
            [not]
                id=Alitar
            [/not]
        ) variables.escaped_from_cave yes}
		
		#clear variables 
		{CLEAR_VARIABLE armor_taken}
		{CLEAR_VARIABLE met_evad}
		{CLEAR_VARIABLE exit_found}
        {CLEAR_VARIABLE illumination}
	[/event]
	#
	# Evad summons guards to protect himself/kill you
	#
    [event]
        name=new turn
		first_time_only=no
		
		[if]
			[variable]
				name=met_evad
				equals=yes
			[/variable]
			
			[then]
			    {RANDOM 1..8}

                [switch]
                    variable=random
					
                    [case]
                        value="1"
		                {EVAD_SUMMONS_MINION 5 "Revenant" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Draug" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Deathblade" 23 5}
                    [/case]
					
                    [case]
                        value="2"
		                {EVAD_SUMMONS_MINION 5 "Bone Shooter" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Banebow" 23 5}
                    [/case]
					
                    [case]
                        value="3"
		                {EVAD_SUMMONS_MINION 5 "Necrophage" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Soulless" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Ghast" 23 5}
                    [/case]
					
                    [case]
                        value="4"
		                {EVAD_SUMMONS_MINION 5 "Deathblade" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Necrophage" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Bone Shooter" 23 5}
                    [/case]
					
                    [case]
                        value="5"
		                {EVAD_SUMMONS_MINION 5 "Death Squire" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton Archer" 23 5}
                    [/case]
					
                    [case]
                        value="6"
		                {EVAD_SUMMONS_MINION 5 "Skeleton" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton Archer" 23 5}
                    [/case]
					
                    [case]
                        value="7"
		                {EVAD_SUMMONS_MINION 5 "Revenant" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Skeleton" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Deathblade" 23 5}
                    [/case]
					
					[else]
		                {EVAD_SUMMONS_MINION 5 "Draug" 22 5}
		                {EVAD_SUMMONS_MINION 5 "Walking Corpse" 21 5}
		                {EVAD_SUMMONS_MINION 5 "Banebow" 23 5}
					[/else]
                [/switch]
			[/then]
		[/if]
		
        {CLEAR_VARIABLE random}
    [/event]
	#
	# For details sake, the illumination tiles go away every four turns.
	# This gives us the illusion that there's still a day/night cycle.
	#
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=illumination
                numerical_equals=2
            [/variable]
			
		    [then]
				[terrain]
					x=28,28,27,27,25,24,23,22,24,25,26,25
					y=20,21,22,23,23,23,23,21,20,20,20,21
					terrain=Qlf^Ii
				[/terrain]
		
				[terrain]
					x=25,26,27,26,23,23,24,27,26,26,25,24,24
					y=19,19,20,23,22,21,19,21,21,22,22,22,21
					terrain=Rb^Ii
				[/terrain]
				
				[terrain]
					x=22,21,22,50,49,49
					y=50,51,51,36,37,38
					terrain=Uu^Ii
				[/terrain]
				
				[terrain]
					x=51,50,51
					y=37,37,38
					terrain=Uh^Ii
				[/terrain]
				
				[terrain]
					x,y=52,37
					terrain=Hhd^Ii
				[/terrain]
		    [/then]
        [/if]

        [if]
            [variable]
                name=illumination
                numerical_equals=6
            [/variable]
			
            [then]
				[terrain]
					x=28,28,27,27,25,24,23,22,24,25,26,25
					y=20,21,22,23,23,23,23,21,20,20,20,21
					terrain=Qlf
				[/terrain]
		
				[terrain]
					x=25,26,27,26,23,23,24,27,26,26,25,24,24
					y=19,19,20,23,22,21,19,21,21,22,22,22,21
					terrain=Rb
				[/terrain]
				
				[terrain]
					x=22,21,22,50,49,49
					y=50,51,51,36,37,38
					terrain=Uu
				[/terrain]
				
				[terrain]
					x=51,50,51
					y=37,37,38
					terrain=Uh
				[/terrain]
				
				[terrain]
					x,y=52,37
					terrain=Hhd
				[/terrain]
            [/then]
        [/if]

        [if]
            [variable]
                name=illumination
                greater_than=6
            [/variable]
			
            [then]
                {VARIABLE illumination 1}
            [/then]
        [/if]

        {VARIABLE_OP illumination add 1}          
    [/event]
	
    {OBJ_VOID_ARMOR 24 28 void_armor}

    {~add-ons/The_Fall_of_Wesnoth/utils/deaths.cfg}
[/scenario]